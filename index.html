<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏±‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
body {
  box-sizing: border-box;
  font-family: 'Kanit', sans-serif;
}

*, *::before, *::after {
  font-family: 'Kanit', sans-serif;
}

.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 16px 24px;
  border-radius: 8px;
  color: white;
  font-weight: 500;
  z-index: 1000;
  animation: slideIn 0.3s ease-out;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast-success { background-color: #10b981; }
.toast-error { background-color: #ef4444; }
.toast-warning { background-color: #f59e0b; }
.toast-info { background-color: #3b82f6; }

.modal {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background-color: white;
  margin: 10% auto;
  padding: 0;
  border-radius: 12px;
  width: 90%;
  max-width: 500px;
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@media (max-width: 768px) {
  .sidebar-mobile {
    position: fixed;
    left: -100%;
    transition: left 0.3s ease;
    z-index: 100;
  }
  
  .sidebar-mobile.active {
    left: 0;
  }
}
</style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gray-50"><!-- ================= LOGIN PAGE ================= -->
  <div id="loginPage" class="h-full flex items-center justify-center bg-gradient-to-br from-blue-600 via-indigo-700 to-purple-700 p-4">
   <div class="bg-white p-6 md:p-10 rounded-2xl shadow-2xl w-full max-w-md">
    <div class="text-center mb-8">
     <div class="text-4xl md:text-5xl mb-4">
      üì¶
     </div>
     <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏±‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏</h2>
     <p class="text-gray-500 text-xs md:text-sm">Material Requisition &amp; Stock Management</p>
    </div>
    <form onsubmit="login(event)" class="space-y-4">
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label> <input id="username" type="text" placeholder="username" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition">
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input id="password" type="password" placeholder="password" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition">
     </div><button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-indigo-700 hover:to-purple-700 transition shadow-lg"> üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö </button>
    </form>
   </div>
  </div><!-- ================= MAIN DASHBOARD ================= -->
  <div id="mainDashboard" class="hidden h-full flex flex-col md:flex-row overflow-hidden"><!-- Mobile Menu Button --> <button id="mobileMenuBtn" onclick="toggleMobileMenu()" class="md:hidden fixed top-4 left-4 z-50 bg-indigo-600 text-white p-3 rounded-lg shadow-lg"> ‚ò∞ </button> <!-- Sidebar -->
   <aside id="sidebar" class="sidebar-mobile w-full md:w-72 bg-gradient-to-b from-indigo-900 to-indigo-800 text-white flex flex-col shadow-xl">
    <div class="p-6 border-b border-indigo-700">
     <div class="text-3xl md:text-4xl mb-3">
      üì¶
     </div>
     <h1 class="text-lg md:text-xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏</h1>
     <p class="text-indigo-300 text-xs md:text-sm mt-1">Stock Management System</p>
    </div>
    <nav class="flex-1 p-4 space-y-2 overflow-y-auto"><button onclick="showSection('addStock')" id="menuAddStock" class="w-full text-left px-4 py-3 rounded-lg hover:bg-indigo-700 transition flex items-center space-x-3 menu-item"> <span class="text-xl">üì•</span> <span class="font-medium text-sm md:text-base">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏</span> </button> <button onclick="showSection('requisition')" id="menuRequisition" class="w-full text-left px-4 py-3 rounded-lg hover:bg-indigo-700 transition flex items-center space-x-3 menu-item"> <span class="text-xl">üìã</span> <span class="font-medium text-sm md:text-base">‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏</span> </button> <button onclick="showSection('history')" id="menuHistory" class="w-full text-left px-4 py-3 rounded-lg hover:bg-indigo-700 transition flex items-center space-x-3 menu-item"> <span class="text-xl">üìú</span> <span class="font-medium text-sm md:text-base">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏</span> </button> <button onclick="showSection('statistics')" id="menuStatistics" class="w-full text-left px-4 py-3 rounded-lg hover:bg-indigo-700 transition flex items-center space-x-3 menu-item"> <span class="text-xl">üìä</span> <span class="font-medium text-sm md:text-base">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span> </button>
    </nav>
    <div class="p-4 border-t border-indigo-700">
     <div class="bg-indigo-800 rounded-lg p-3 mb-3">
      <div class="text-indigo-300 text-xs mb-1">
       ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
      </div>
      <div class="font-semibold text-sm md:text-base">
       ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö
      </div>
     </div>
     <div id="firebaseStatus" class="text-xs text-indigo-300 mb-3 text-center">
      üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...
     </div><button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 py-3 rounded-lg font-semibold transition shadow-lg text-sm md:text-base"> üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö </button>
    </div>
   </aside><!-- Main Content -->
   <main class="flex-1 overflow-y-auto bg-gray-50"><!-- ================= ADD STOCK SECTION ================= -->
    <section id="addStock" class="p-4 md:p-8 section-content">
     <div class="mb-6">
      <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">üì• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏</h2>
      <p class="text-gray-600 text-sm md:text-base">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏</p>
     </div>
     <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 max-w-4xl">
      <form onsubmit="addStock(event)" class="space-y-5">
       <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏</label> <input id="stockMaterialName" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition">
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label> <input id="stockQuantity" type="number" min="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition">
        </div>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡πÅ‡∏ú‡∏ô‡∏Å</label> <select id="stockDepartment" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition bg-white"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option> <option value="‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå">‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</option> <option value="‡πÅ‡∏ú‡∏ô‡∏Å‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå</option> </select>
       </div>
       <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3 pt-4"><button type="submit" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-lg font-semibold hover:from-green-600 hover:to-emerald-700 transition shadow-lg"> üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• </button> <button type="reset" class="px-6 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition"> üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• </button>
       </div>
      </form>
     </div><!-- Current Stock Table -->
     <div class="mt-8 bg-white rounded-xl shadow-lg p-4 md:p-6">
      <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
      <div class="overflow-x-auto">
       <table class="w-full min-w-max">
        <thead class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
         <tr>
          <th class="px-3 md:px-4 py-3 text-left font-semibold text-sm md:text-base">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏</th>
          <th class="px-3 md:px-4 py-3 text-left font-semibold text-sm md:text-base">‡πÅ‡∏ú‡∏ô‡∏Å</th>
          <th class="px-3 md:px-4 py-3 text-center font-semibold text-sm md:text-base">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
          <th class="px-3 md:px-4 py-3 text-left font-semibold text-sm md:text-base hidden md:table-cell">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th>
          <th class="px-3 md:px-4 py-3 text-center font-semibold text-sm md:text-base">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
         </tr>
        </thead>
        <tbody id="stockTableBody" class="divide-y divide-gray-200">
         <tr>
          <td colspan="5" class="px-4 py-8 text-center text-gray-500">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </section><!-- ================= REQUISITION SECTION ================= -->
    <section id="requisition" class="hidden p-4 md:p-8 section-content">
     <div class="mb-6">
      <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">üìã ‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏</h2>
      <p class="text-gray-600 text-sm md:text-base">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</p>
     </div>
     <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 max-w-4xl">
      <form onsubmit="submitRequisition(event)" class="space-y-5">
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</label> <input id="requesterName" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition">
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡πÅ‡∏ú‡∏ô‡∏Å</label> <select id="reqDepartment" onchange="filterMaterialsByDept()" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition bg-white"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option> <option value="‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå">‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</option> <option value="‡πÅ‡∏ú‡∏ô‡∏Å‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå</option> </select>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏</label> <select id="reqMaterial" onchange="updateAvailableQty()" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition bg-white"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡πà‡∏≠‡∏ô --</option> </select>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</label> <input id="reqQuantity" type="number" min="1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition">
        <div id="availableQtyDisplay" class="mt-2 text-sm font-medium text-gray-600"></div>
       </div>
       <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3 pt-4"><button type="submit" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-indigo-700 transition shadow-lg"> ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å </button> <button type="reset" onclick="clearRequisitionForm()" class="px-6 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition"> üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• </button>
       </div>
      </form>
     </div>
    </section><!-- ================= HISTORY SECTION ================= -->
    <section id="history" class="hidden p-4 md:p-8 section-content">
     <div class="mb-6">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center space-y-4 md:space-y-0">
       <div>
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏</h2>
        <p class="text-gray-600 text-sm md:text-base">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
       </div><button onclick="exportToExcel()" class="bg-gradient-to-r from-emerald-500 to-green-600 text-white px-4 md:px-6 py-3 rounded-lg font-semibold hover:from-emerald-600 hover:to-green-700 transition shadow-lg flex items-center justify-center space-x-2 text-sm md:text-base"> <span>üì•</span> <span>Export Excel</span> </button>
      </div>
     </div><!-- Date Filter -->
     <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label> <input id="filterStartDate" type="date" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition">
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label> <input id="filterEndDate" type="date" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition">
       </div>
       <div class="flex items-end space-x-2"><button onclick="filterHistory()" class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-700 transition text-sm md:text-base"> ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• </button> <button onclick="clearFilter()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition text-sm md:text-base"> ‡∏•‡πâ‡∏≤‡∏á </button>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-xl shadow-lg p-4 md:p-6">
      <div class="overflow-x-auto">
       <table class="w-full min-w-max">
        <thead class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
         <tr>
          <th class="px-3 md:px-4 py-3 text-left font-semibold text-sm md:text-base">‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</th>
          <th class="px-3 md:px-4 py-3 text-left font-semibold text-sm md:text-base">‡∏ß‡∏±‡∏™‡∏î‡∏∏</th>
          <th class="px-3 md:px-4 py-3 text-left font-semibold text-sm md:text-base hidden lg:table-cell">‡πÅ‡∏ú‡∏ô‡∏Å</th>
          <th class="px-3 md:px-4 py-3 text-center font-semibold text-sm md:text-base">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th class="px-3 md:px-4 py-3 text-left font-semibold text-sm md:text-base">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
          <th class="px-3 md:px-4 py-3 text-left font-semibold text-sm md:text-base hidden md:table-cell">‡πÄ‡∏ß‡∏•‡∏≤</th>
          <th class="px-3 md:px-4 py-3 text-center font-semibold text-sm md:text-base">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
         </tr>
        </thead>
        <tbody id="historyTableBody" class="divide-y divide-gray-200">
         <tr>
          <td colspan="7" class="px-4 py-8 text-center text-gray-500">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </section><!-- ================= STATISTICS SECTION ================= -->
    <section id="statistics" class="hidden p-4 md:p-8 section-content">
     <div class="mb-6">
      <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
      <p class="text-gray-600 text-sm md:text-base">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏</p>
     </div>
     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow-lg p-4 md:p-6">
       <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">‚ö†Ô∏è ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</h3>
       <canvas id="lowStockChart"></canvas>
      </div>
      <div class="bg-white rounded-xl shadow-lg p-4 md:p-6">
       <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">üî• ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
       <canvas id="mostRequisitionedChart"></canvas>
      </div>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
      <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-xl shadow-lg p-4 md:p-6">
       <div class="text-2xl md:text-3xl mb-2">
        üì¶
       </div>
       <div class="text-2xl md:text-3xl font-bold mb-1" id="totalMaterials">
        0
       </div>
       <div class="text-blue-100 text-sm md:text-base">
        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
       </div>
      </div>
      <div class="bg-gradient-to-br from-purple-500 to-pink-600 text-white rounded-xl shadow-lg p-4 md:p-6">
       <div class="text-2xl md:text-3xl mb-2">
        üìã
       </div>
       <div class="text-2xl md:text-3xl font-bold mb-1" id="totalRequisitions">
        0
       </div>
       <div class="text-purple-100 text-sm md:text-base">
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
       </div>
      </div>
      <div class="bg-gradient-to-br from-emerald-500 to-green-600 text-white rounded-xl shadow-lg p-4 md:p-6">
       <div class="text-2xl md:text-3xl mb-2">
        ‚ö†Ô∏è
       </div>
       <div class="text-2xl md:text-3xl font-bold mb-1" id="lowStockCount">
        0
       </div>
       <div class="text-emerald-100 text-sm md:text-base">
        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥ (‚â§5)
       </div>
      </div>
      <div class="bg-gradient-to-br from-red-500 to-rose-600 text-white rounded-xl shadow-lg p-4 md:p-6">
       <div class="text-2xl md:text-3xl mb-2">
        ‚ùå
       </div>
       <div class="text-2xl md:text-3xl font-bold mb-1" id="outOfStockCount">
        0
       </div>
       <div class="text-red-100 text-sm md:text-base">
        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å (=0)
       </div>
      </div>
     </div>
    </section>
   </main>
  </div><!-- ================= EDIT STOCK MODAL ================= -->
  <div id="editStockModal" class="modal">
   <div class="modal-content">
    <div class="bg-amber-600 text-white p-4 md:p-6 rounded-t-xl">
     <h3 class="text-xl md:text-2xl font-bold">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏™‡∏î‡∏∏</h3>
    </div>
    <div class="p-4 md:p-6">
     <form onsubmit="confirmEditStock(event)" class="space-y-4">
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏</label> <input id="editStockName" type="text" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-amber-500 focus:outline-none transition">
      </div>
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label> <input id="editStockQuantity" type="number" min="0" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-amber-500 focus:outline-none transition">
      </div>
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡πÅ‡∏ú‡∏ô‡∏Å</label> <input id="editStockDepartment" type="text" readonly class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg bg-gray-100 cursor-not-allowed">
      </div>
      <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3 pt-4"><button type="submit" class="flex-1 bg-amber-600 text-white py-3 rounded-lg font-semibold hover:bg-amber-700 transition"> ‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç </button> <button type="button" onclick="closeEditStockModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition"> ‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- ================= DELETE CONFIRMATION MODAL ================= -->
  <div id="deleteModal" class="modal">
   <div class="modal-content">
    <div class="bg-red-600 text-white p-4 md:p-6 rounded-t-xl">
     <h3 class="text-xl md:text-2xl font-bold">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
    </div>
    <div class="p-4 md:p-6">
     <p class="text-gray-700 mb-6 text-sm md:text-base" id="deleteMessage">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?</p>
     <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3"><button onclick="confirmDelete()" class="flex-1 bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition"> ‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö </button> <button onclick="closeDeleteModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition"> ‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button>
     </div>
    </div>
   </div>
  </div><!-- ================= RETURN STOCK MODAL ================= -->
  <div id="returnStockModal" class="modal">
   <div class="modal-content">
    <div class="bg-blue-600 text-white p-4 md:p-6 rounded-t-xl">
     <h3 class="text-xl md:text-2xl font-bold">‚Ü©Ô∏è ‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</h3>
    </div>
    <div class="p-4 md:p-6">
     <p class="text-gray-700 mb-6 text-sm md:text-base" id="returnMessage">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ô‡∏µ‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
     <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
      <p class="text-sm text-blue-800">üìå ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</p>
     </div>
     <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3"><button onclick="confirmReturnStock()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"> ‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å </button> <button onclick="closeReturnStockModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition"> ‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button>
     </div>
    </div>
   </div>
  </div><!-- ================= FIREBASE & JAVASCRIPT ================= -->
  <script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getDatabase, ref, set, push, onValue, update, get, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyA3hnlQ_hXg6gDn3EYlFmcIBLoPAiwwt0w",
    authDomain: "requistionsystem-33881.firebaseapp.com",
    databaseURL: "https://requistionsystem-33881-default-rtdb.firebaseio.com",
    projectId: "requistionsystem-33881",
    storageBucket: "requistionsystem-33881.firebasestorage.app",
    messagingSenderId: "607877375638",
    appId: "1:607877375638:web:fc4bf066a367d9f637dc7b",
    measurementId: "G-M3N19WESNP"
  };

  // Initialize Firebase
  let app, db;
  let isFirebaseReady = false;

  try {
    app = initializeApp(firebaseConfig);
    db = getDatabase(app);
    isFirebaseReady = true;
    
    console.log('‚úÖ Firebase initialized successfully');
    console.log('Database URL:', firebaseConfig.databaseURL);
    
    // Update status
    const statusEl = document.getElementById('firebaseStatus');
    if (statusEl) {
      statusEl.innerHTML = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      statusEl.className = 'text-xs text-green-400 mb-3 text-center';
    }
  } catch (error) {
    console.error('‚ùå Firebase initialization error:', error);
    isFirebaseReady = false;
    
    const statusEl = document.getElementById('firebaseStatus');
    if (statusEl) {
      statusEl.innerHTML = '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
      statusEl.className = 'text-xs text-red-400 mb-3 text-center';
    }
  }

  // Make Firebase accessible globally
  window.firebaseApp = app;
  window.firebaseDb = db;
  window.firebaseRef = { ref, set, push, onValue, update, get, remove };
  window.isFirebaseReady = isFirebaseReady;

  // Global variables
  let deleteTarget = null;
  let deleteType = null;
  let editStockKey = null;
  let returnStockData = null;
  let allRequisitions = [];

  // Toast notification system
  window.showToast = function(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.animation = 'slideIn 0.3s ease-out reverse';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  };

  // Mobile menu toggle
  window.toggleMobileMenu = function() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('active');
  };

  // Login function
  window.login = function(event) {
    event.preventDefault();
    
    if (!window.isFirebaseReady) {
      showToast('‚ùå Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'error');
      return;
    }
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    if (username === 'Admin' && password === 'Admin1234') {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('mainDashboard').classList.remove('hidden');
      showSection('addStock');
      showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö Admin', 'success');
      loadAllData();
    } else {
      showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
    }
  };

  // Logout function
  window.logout = function() {
    document.getElementById('mainDashboard').classList.add('hidden');
    document.getElementById('loginPage').classList.remove('hidden');
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'info');
  };

  // Show section function
  window.showSection = function(sectionName) {
    const sections = document.querySelectorAll('.section-content');
    sections.forEach(section => section.classList.add('hidden'));
    
    const menuItems = document.querySelectorAll('.menu-item');
    menuItems.forEach(item => item.classList.remove('bg-indigo-700'));
    
    document.getElementById(sectionName).classList.remove('hidden');
    document.getElementById('menu' + sectionName.charAt(0).toUpperCase() + sectionName.slice(1)).classList.add('bg-indigo-700');

    // Close mobile menu
    if (window.innerWidth < 768) {
      document.getElementById('sidebar').classList.remove('active');
    }

    if (sectionName === 'statistics') {
      setTimeout(updateStatistics, 100);
    }
  };

  // Add stock function
  window.addStock = function(event) {
    event.preventDefault();
    
    if (!window.isFirebaseReady) {
      showToast('‚ùå Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'error');
      return;
    }
    
    const materialName = document.getElementById('stockMaterialName').value.trim();
    const quantity = parseInt(document.getElementById('stockQuantity').value);
    const department = document.getElementById('stockDepartment').value;

    if (!materialName || !quantity || !department) {
      showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
      return;
    }

    if (quantity <= 0) {
      showToast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'warning');
      return;
    }

    console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å:', { materialName, quantity, department });

    const stockRef = window.firebaseRef.ref(window.firebaseDb, 'stocks');
    
    window.firebaseRef.get(stockRef).then((snapshot) => {
      let existingKey = null;
      
      if (snapshot.exists()) {
        snapshot.forEach((child) => {
          const item = child.val();
          if (item.name === materialName && item.department === department) {
            existingKey = child.key;
          }
        });
      }

      const timestamp = new Date().toLocaleString('th-TH', { 
        timeZone: 'Asia/Bangkok',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });

      if (existingKey) {
        console.log('üìù ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏°:', existingKey);
        const existingRef = window.firebaseRef.ref(window.firebaseDb, `stocks/${existingKey}`);
        window.firebaseRef.get(existingRef).then((snap) => {
          const currentQty = snap.val().quantity || 0;
          window.firebaseRef.update(existingRef, {
            quantity: currentQty + quantity,
            lastUpdated: timestamp
          }).then(() => {
            console.log('‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å "${materialName}" ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${quantity} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
            event.target.reset();
          }).catch((error) => {
            console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó:', error);
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
          });
        });
      } else {
        console.log('‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà');
        const newStockRef = window.firebaseRef.push(stockRef);
        window.firebaseRef.set(newStockRef, {
          name: materialName,
          quantity: quantity,
          department: department,
          lastUpdated: timestamp
        }).then(() => {
          console.log('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏´‡∏°‡πà "${materialName}" ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${quantity} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
          event.target.reset();
        }).catch((error) => {
          console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâÔøΩÔøΩ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á:', error);
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
        });
      }
    }).catch((error) => {
      console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', error);
      showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
    });
  };

  // Load stock data
  function loadStockData() {
    if (!window.isFirebaseReady) {
      console.warn('‚ö†Ô∏è Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');
      return;
    }

    console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å...');
    const stockRef = window.firebaseRef.ref(window.firebaseDb, 'stocks');
    
    window.firebaseRef.onValue(stockRef, (snapshot) => {
      console.log('üìä ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å:', snapshot.exists());
      
      const tbody = document.getElementById('stockTableBody');
      tbody.innerHTML = '';

      if (snapshot.exists()) {
        const stocks = [];
        snapshot.forEach((child) => {
          stocks.push({ key: child.key, ...child.val() });
        });

        console.log('‚úÖ ‡∏û‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å:', stocks.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        stocks.sort((a, b) => a.name.localeCompare(b.name, 'th'));

        stocks.forEach((stock) => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50';
          
          const qtyClass = stock.quantity <= 5 ? 'text-red-600 font-bold' : 'text-gray-800';
          
          row.innerHTML = `
            <td class="px-3 md:px-4 py-3 text-sm md:text-base">${stock.name}</td>
            <td class="px-3 md:px-4 py-3 text-sm md:text-base">${stock.department}</td>
            <td class="px-3 md:px-4 py-3 text-center ${qtyClass} text-sm md:text-base">${stock.quantity}</td>
            <td class="px-3 md:px-4 py-3 text-xs md:text-sm text-gray-600 hidden md:table-cell">${stock.lastUpdated}</td>
            <td class="px-3 md:px-4 py-3 text-center">
              <div class="flex flex-col md:flex-row gap-2 justify-center">
                <button onclick="showEditStockModal('${stock.key}', '${stock.name.replace(/'/g, "\\'")}', ${stock.quantity}, '${stock.department}')" 
                        class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold transition text-xs md:text-sm">
                  ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
                <button onclick="showDeleteStockModal('${stock.key}', '${stock.name.replace(/'/g, "\\'")}', '${stock.department}')" 
                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold transition text-xs md:text-sm">
                  üóëÔ∏è ‡∏•‡∏ö
                </button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });
      } else {
        console.log('‚ÑπÔ∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å');
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500 text-sm md:text-base">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å</td></tr>';
      }
    }, (error) => {
      console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å:', error);
      showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏î‡πâ', 'error');
    });
  }

  // Show edit stock modal
  window.showEditStockModal = function(key, name, quantity, department) {
    editStockKey = key;
    document.getElementById('editStockName').value = name;
    document.getElementById('editStockQuantity').value = quantity;
    document.getElementById('editStockDepartment').value = department;
    document.getElementById('editStockModal').style.display = 'block';
  };

  // Close edit stock modal
  window.closeEditStockModal = function() {
    document.getElementById('editStockModal').style.display = 'none';
    editStockKey = null;
  };

  // Confirm edit stock
  window.confirmEditStock = function(event) {
    event.preventDefault();
    
    if (!editStockKey || !window.isFirebaseReady) {
      showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
      return;
    }

    const newName = document.getElementById('editStockName').value.trim();
    const newQuantity = parseInt(document.getElementById('editStockQuantity').value);

    if (!newName || newQuantity < 0) {
      showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'warning');
      return;
    }

    console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ï‡πá‡∏≠‡∏Å:', editStockKey);

    const timestamp = new Date().toLocaleString('th-TH', { 
      timeZone: 'Asia/Bangkok',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });

    const stockRef = window.firebaseRef.ref(window.firebaseDb, `stocks/${editStockKey}`);
    
    window.firebaseRef.update(stockRef, {
      name: newName,
      quantity: newQuantity,
      lastUpdated: timestamp
    }).then(() => {
      console.log('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      showToast(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "${newName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
      closeEditStockModal();
    }).catch((error) => {
      console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error);
      showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
    });
  };

  // Show delete stock modal
  window.showDeleteStockModal = function(key, name, department) {
    deleteTarget = key;
    deleteType = 'stock';
    document.getElementById('deleteMessage').textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏±‡∏™‡∏î‡∏∏ "${name}" (${department}) ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`;
    document.getElementById('deleteModal').style.display = 'block';
  };

  // Filter materials by department
  window.filterMaterialsByDept = function() {
    if (!window.isFirebaseReady) {
      showToast('Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°', 'warning');
      return;
    }

    const dept = document.getElementById('reqDepartment').value;
    const materialSelect = document.getElementById('reqMaterial');
    materialSelect.innerHTML = '<option value="">-- ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà --</option>';
    
    document.getElementById('availableQtyDisplay').textContent = '';
    document.getElementById('reqQuantity').value = '';

    if (!dept) {
      materialSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡πà‡∏≠‡∏ô --</option>';
      return;
    }

    console.log('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å:', dept);

    const stockRef = window.firebaseRef.ref(window.firebaseDb, 'stocks');
    window.firebaseRef.get(stockRef).then((snapshot) => {
      materialSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏ --</option>';
      
      if (snapshot.exists()) {
        const materials = [];
        snapshot.forEach((child) => {
          const item = child.val();
          console.log('üì¶ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:', item.name, '| ‡πÅ‡∏ú‡∏ô‡∏Å:', item.department, '| ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:', dept);
          
          // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå
          const itemDept = (item.department || '').trim();
          const selectedDept = dept.trim();
          
          if (itemDept === selectedDept && item.quantity > 0) {
            materials.push({ key: child.key, name: item.name, qty: item.quantity });
            console.log('‚úÖ ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏¥‡∏™‡∏ï‡πå:', item.name);
          }
        });

        console.log('üìã ‡∏û‡∏ö‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:', materials.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

        materials.sort((a, b) => a.name.localeCompare(b.name, 'th'));

        materials.forEach((mat) => {
          const option = document.createElement('option');
          option.value = mat.key;
          option.textContent = `${mat.name} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${mat.qty})`;
          materialSelect.appendChild(option);
        });

        if (materials.length === 0) {
          materialSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ô‡∏µ‡πâ --</option>';
          console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ô‡∏µ‡πâ');
        }
      } else {
        materialSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ô‡∏µ‡πâ --</option>';
        console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
      }
    }).catch((error) => {
      console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á:', error);
      showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏±‡∏™‡∏î‡∏∏', 'error');
    });
  };

  // Update available quantity display
  window.updateAvailableQty = function() {
    const materialKey = document.getElementById('reqMaterial').value;
    const display = document.getElementById('availableQtyDisplay');
    
    if (!materialKey) {
      display.textContent = '';
      return;
    }

    const stockRef = window.firebaseRef.ref(window.firebaseDb, `stocks/${materialKey}`);
    window.firebaseRef.get(stockRef).then((snapshot) => {
      if (snapshot.exists()) {
        const qty = snapshot.val().quantity;
        const color = qty <= 5 ? 'text-red-600' : 'text-green-600';
        display.innerHTML = `<span class="${color}">üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${qty} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>`;
      }
    });
  };

  // Submit requisition
  window.submitRequisition = function(event) {
    event.preventDefault();

    if (!window.isFirebaseReady) {
      showToast('Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'error');
      return;
    }

    const requesterName = document.getElementById('requesterName').value.trim();
    const materialKey = document.getElementById('reqMaterial').value;
    const reqQty = parseInt(document.getElementById('reqQuantity').value);

    if (!requesterName || !materialKey || !reqQty) {
      showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
      return;
    }

    if (reqQty <= 0) {
      showToast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'warning');
      return;
    }

    console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏:', { requesterName, materialKey, reqQty });

    const stockRef = window.firebaseRef.ref(window.firebaseDb, `stocks/${materialKey}`);
    
    window.firebaseRef.get(stockRef).then((snapshot) => {
      if (!snapshot.exists()) {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'error');
        return;
      }

      const stock = snapshot.val();
      
      if (stock.quantity < reqQty) {
        showToast(`‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠! ‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${stock.quantity} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'error');
        return;
      }

      const now = new Date();
      const timestamp = now.toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
      const date = now.toLocaleDateString('th-TH');
      const time = now.toLocaleTimeString('th-TH');
      const isoDate = now.toISOString().split('T')[0];

      const historyRef = window.firebaseRef.ref(window.firebaseDb, 'requisitions');
      const newReqRef = window.firebaseRef.push(historyRef);
      
      window.firebaseRef.set(newReqRef, {
        requesterName: requesterName,
        materialName: stock.name,
        department: stock.department,
        quantity: reqQty,
        stockKey: materialKey,
        date: date,
        time: time,
        timestamp: timestamp,
        isoDate: isoDate
      }).then(() => {
        console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        return window.firebaseRef.update(stockRef, {
          quantity: stock.quantity - reqQty,
          lastUpdated: timestamp
        });
      }).then(() => {
        console.log('‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        showToast(`‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏ "${stock.name}" ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${reqQty} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        clearRequisitionForm();
      }).catch((error) => {
        console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      });
    });
  };

  // Clear requisition form
  window.clearRequisitionForm = function() {
    document.getElementById('requesterName').value = '';
    document.getElementById('reqDepartment').value = '';
    document.getElementById('reqMaterial').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡πà‡∏≠‡∏ô --</option>';
    document.getElementById('reqQuantity').value = '';
    document.getElementById('availableQtyDisplay').textContent = '';
  };

  // Load requisition history
  function loadRequisitionHistory() {
    if (!window.isFirebaseReady) {
      console.warn('‚ö†Ô∏è Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');
      return;
    }

    console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å...');
    const historyRef = window.firebaseRef.ref(window.firebaseDb, 'requisitions');
    
    window.firebaseRef.onValue(historyRef, (snapshot) => {
      console.log('üìä ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:', snapshot.exists());
      
      allRequisitions = [];
      
      if (snapshot.exists()) {
        snapshot.forEach((child) => {
          allRequisitions.push({ key: child.key, ...child.val() });
        });
        console.log('‚úÖ ‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:', allRequisitions.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
      } else {
        console.log('‚ÑπÔ∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å');
      }
      
      displayRequisitions(allRequisitions);
    }, (error) => {
      console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:', error);
      showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏î‡πâ', 'error');
    });
  }

  // Display requisitions
  function displayRequisitions(requisitions) {
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = '';

    if (requisitions.length > 0) {
      const sorted = [...requisitions].reverse();

      sorted.forEach((req) => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
          <td class="px-3 md:px-4 py-3 font-medium text-sm md:text-base">${req.requesterName}</td>
          <td class="px-3 md:px-4 py-3 text-sm md:text-base">${req.materialName}</td>
          <td class="px-3 md:px-4 py-3 text-sm md:text-base hidden lg:table-cell">${req.department}</td>
          <td class="px-3 md:px-4 py-3 text-center font-semibold text-indigo-600 text-sm md:text-base">${req.quantity}</td>
          <td class="px-3 md:px-4 py-3 text-xs md:text-sm">${req.date}</td>
          <td class="px-3 md:px-4 py-3 text-xs md:text-sm hidden md:table-cell">${req.time}</td>
          <td class="px-3 md:px-4 py-3 text-center">
            <div class="flex flex-col md:flex-row gap-2 justify-center">
              <button onclick='window.showReturnStockModal(${JSON.stringify(req)})' 
                      class="return-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 md:px-3 md:py-1 rounded-lg font-semibold transition text-xs md:text-sm">
                ‚Ü©Ô∏è ‡∏Ñ‡∏∑‡∏ô
              </button>
              <button onclick="showDeleteHistoryModal('${req.key}', '${req.materialName.replace(/'/g, "\\'")}', '${req.requesterName.replace(/'/g, "\\'")}', '${req.date}')" 
                      class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 md:px-3 md:py-1 rounded-lg font-semibold transition text-xs md:text-sm">
                üóëÔ∏è ‡∏•‡∏ö
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    } else {
      tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500 text-sm md:text-base">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</td></tr>';
    }
  }

  // Show return stock modal
  window.showReturnStockModal = function(reqData) {
    console.log('üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å:', reqData);
    returnStockData = reqData;
    document.getElementById('returnMessage').innerHTML = `
      ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏ "<strong>${reqData.materialName}</strong>" ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <strong>${reqData.quantity}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÅ‡∏ú‡∏ô‡∏Å: <strong>${reqData.department}</strong>) ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
    `;
    document.getElementById('returnStockModal').style.display = 'block';
  };

  // Close return stock modal
  window.closeReturnStockModal = function() {
    document.getElementById('returnStockModal').style.display = 'none';
    returnStockData = null;
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏°‡∏î‡∏≠‡∏•‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
    const confirmBtn = document.querySelector('#returnStockModal button[onclick="confirmReturnStock()"]');
    const cancelBtn = document.querySelector('#returnStockModal button[onclick="closeReturnStockModal()"]');
    
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.textContent = '‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å';
      confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
    
    if (cancelBtn) {
      cancelBtn.disabled = false;
      cancelBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
    
    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡∏°‡πà
    const allReturnButtons = document.querySelectorAll('.return-btn');
    allReturnButtons.forEach(btn => {
      btn.disabled = false;
      btn.classList.remove('opacity-50', 'cursor-not-allowed');
    });
  };

  // Confirm return stock
  window.confirmReturnStock = function() {
    if (!returnStockData || !window.isFirebaseReady) {
      showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
      closeReturnStockModal();
      return;
    }

    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÇ‡∏°‡∏î‡∏≠‡∏•
    const confirmBtn = document.querySelector('#returnStockModal button[onclick="confirmReturnStock()"]');
    const cancelBtn = document.querySelector('#returnStockModal button[onclick="closeReturnStockModal()"]');
    
    if (confirmBtn) {
      confirmBtn.disabled = true;
      confirmBtn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
      confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
    
    if (cancelBtn) {
      cancelBtn.disabled = true;
      cancelBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }

    // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    const allReturnButtons = document.querySelectorAll('.return-btn');
    allReturnButtons.forEach(btn => {
      btn.disabled = true;
      btn.classList.add('opacity-50', 'cursor-not-allowed');
    });

    console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å:', returnStockData);

    let stockKey = returnStockData.stockKey;
    const reqKey = returnStockData.key;
    const returnQty = returnStockData.quantity;
    const materialName = returnStockData.materialName;
    const department = returnStockData.department;

    const timestamp = new Date().toLocaleString('th-TH', { 
      timeZone: 'Asia/Bangkok',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ stockKey ‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ÔøΩÔøΩ‡∏±‡∏™‡∏î‡∏∏‡πÅÔøΩÔøΩ‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å
    const findAndReturnStock = () => {
      if (stockKey) {
        // ‡∏°‡∏µ stockKey ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏á‡πÜ
        const stockRef = window.firebaseRef.ref(window.firebaseDb, `stocks/${stockKey}`);
        return window.firebaseRef.get(stockRef).then((snapshot) => {
          if (snapshot.exists()) {
            return { key: stockKey, stock: snapshot.val() };
          } else {
            // stockKey ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà
            return findStockByNameAndDept();
          }
        });
      } else {
        // ‡πÑ‡∏°‡πà‡∏°‡∏µ stockKey ‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        return findStockByNameAndDept();
      }
    };

    const findStockByNameAndDept = () => {
      console.log('üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏≤‡∏Å:', { materialName, department });
      const stocksRef = window.firebaseRef.ref(window.firebaseDb, 'stocks');
      return window.firebaseRef.get(stocksRef).then((snapshot) => {
        if (!snapshot.exists()) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
        }

        let foundKey = null;
        let foundStock = null;

        snapshot.forEach((child) => {
          const stock = child.val();
          if (stock.name === materialName && stock.department === department) {
            foundKey = child.key;
            foundStock = stock;
          }
        });

        if (!foundKey) {
          throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏™‡∏î‡∏∏ "${materialName}" ‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å "${department}"`);
        }

        console.log('‚úÖ ‡∏û‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô:', foundKey);
        return { key: foundKey, stock: foundStock };
      });
    };

    findAndReturnStock().then((result) => {
      const targetStockKey = result.key;
      const currentStock = result.stock;
      const newQuantity = currentStock.quantity + returnQty;

      console.log('üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ï‡πá‡∏≠‡∏Å:', { currentQty: currentStock.quantity, returnQty, newQty: newQuantity });

      const stockRef = window.firebaseRef.ref(window.firebaseDb, `stocks/${targetStockKey}`);
      return window.firebaseRef.update(stockRef, {
        quantity: newQuantity,
        lastUpdated: timestamp
      });
    }).then(() => {
      console.log('‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      const reqRef = window.firebaseRef.ref(window.firebaseDb, `requisitions/${reqKey}`);
      return window.firebaseRef.remove(reqRef);
    }).then(() => {
      console.log('‚úÖ ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      showToast(`‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏ "${materialName}" ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${returnQty} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
      closeReturnStockModal();
    }).catch((error) => {
      console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error);
      showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      
      // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
      if (confirmBtn) {
        confirmBtn.disabled = false;
        confirmBtn.textContent = '‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å';
        confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
      
      if (cancelBtn) {
        cancelBtn.disabled = false;
        cancelBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
      
      const allReturnButtons = document.querySelectorAll('.return-btn');
      allReturnButtons.forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
      });
    });
  };

  // Filter history
  window.filterHistory = function() {
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;

    if (!startDate || !endDate) {
      showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', 'warning');
      return;
    }

    if (startDate > endDate) {
      showToast('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', 'warning');
      return;
    }

    const filtered = allRequisitions.filter(req => {
      const reqDate = req.isoDate || req.date;
      return reqDate >= startDate && reqDate <= endDate;
    });

    displayRequisitions(filtered);
    showToast(`‡∏û‡∏ö ${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å`, 'info');
  };

  // Clear filter
  window.clearFilter = function() {
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterEndDate').value = '';
    displayRequisitions(allRequisitions);
    showToast('‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'info');
  };

  // Show delete history modal
  window.showDeleteHistoryModal = function(key, materialName, requesterName, date) {
    deleteTarget = key;
    deleteType = 'history';
    document.getElementById('deleteMessage').textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å "${materialName}" ‡πÇ‡∏î‡∏¢ ${requesterName} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`;
    document.getElementById('deleteModal').style.display = 'block';
  };

  // Confirm delete
  window.confirmDelete = function() {
    if (!deleteTarget || !deleteType) return;

    if (!window.isFirebaseReady) {
      showToast('Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'error');
      closeDeleteModal();
      return;
    }

    console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö:', deleteType, deleteTarget);

    if (deleteType === 'stock') {
      const stockRef = window.firebaseRef.ref(window.firebaseDb, `stocks/${deleteTarget}`);
      window.firebaseRef.remove(stockRef).then(() => {
        console.log('‚úÖ ‡∏•‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        showToast('‡∏•‡∏ö‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        closeDeleteModal();
      }).catch((error) => {
        console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      });
    } else if (deleteType === 'history') {
      const historyRef = window.firebaseRef.ref(window.firebaseDb, `requisitions/${deleteTarget}`);
      window.firebaseRef.remove(historyRef).then(() => {
        console.log('‚úÖ ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        showToast('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        closeDeleteModal();
      }).catch((error) => {
        console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      });
    }
  };

  // Close delete modal
  window.closeDeleteModal = function() {
    document.getElementById('deleteModal').style.display = 'none';
    deleteTarget = null;
    deleteType = null;
  };

  // Export to Excel
  window.exportToExcel = function() {
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;

    let dataToExport = allRequisitions;

    if (startDate && endDate) {
      dataToExport = allRequisitions.filter(req => {
        const reqDate = req.isoDate || req.date;
        return reqDate >= startDate && reqDate <= endDate;
      });
    }

    if (dataToExport.length === 0) {
      showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'warning');
      return;
    }

    const data = [];
    data.push(['‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å', '‡∏ß‡∏±‡∏™‡∏î‡∏∏', '‡πÅ‡∏ú‡∏ô‡∏Å', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏ß‡∏•‡∏≤']);

    dataToExport.forEach((req) => {
      data.push([
        req.requesterName,
        req.materialName,
        req.department,
        req.quantity,
        req.date,
        req.time
      ]);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    ws['!cols'] = [
      { wch: 20 },
      { wch: 30 },
      { wch: 25 },
      { wch: 10 },
      { wch: 15 },
      { wch: 12 }
    ];

    XLSX.utils.book_append_sheet(wb, ws, '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å');
    
    let filename = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
    if (startDate && endDate) {
      filename += `_${startDate}_‡∏ñ‡∏∂‡∏á_${endDate}`;
    }
    filename += '.xlsx';
    
    XLSX.writeFile(wb, filename);
    
    showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
  };

  // Update statistics
  let lowStockChart = null;
  let mostReqChart = null;

  window.updateStatistics = function() {
    if (!window.isFirebaseReady) {
      showToast('Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°', 'warning');
      return;
    }

    const stockRef = window.firebaseRef.ref(window.firebaseDb, 'stocks');
    const reqRef = window.firebaseRef.ref(window.firebaseDb, 'requisitions');

    Promise.all([
      window.firebaseRef.get(stockRef),
      window.firebaseRef.get(reqRef)
    ]).then(([stockSnapshot, reqSnapshot]) => {
      // Total materials
      let totalMaterials = 0;
      let lowStockCount = 0;
      let outOfStockCount = 0;
      const stocks = [];

      if (stockSnapshot.exists()) {
        stockSnapshot.forEach((child) => {
          const stock = child.val();
          totalMaterials++;
          if (stock.quantity === 0) outOfStockCount++;
          else if (stock.quantity <= 5) lowStockCount++;
          stocks.push(stock);
        });
      }

      document.getElementById('totalMaterials').textContent = totalMaterials;
      document.getElementById('lowStockCount').textContent = lowStockCount;
      document.getElementById('outOfStockCount').textContent = outOfStockCount;

      // Low stock chart
      stocks.sort((a, b) => a.quantity - b.quantity);
      const top5Low = stocks.slice(0, 5);

      const ctx1 = document.getElementById('lowStockChart');
      if (lowStockChart) lowStockChart.destroy();
      
      lowStockChart = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: top5Low.map(s => s.name.length > 15 ? s.name.substring(0, 15) + '...' : s.name),
          datasets: [{
            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠',
            data: top5Low.map(s => s.quantity),
            backgroundColor: 'rgba(239, 68, 68, 0.8)',
            borderColor: 'rgba(239, 68, 68, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });

      // Most requisitioned
      let totalRequisitions = 0;
      const reqCount = {};

      if (reqSnapshot.exists()) {
        reqSnapshot.forEach((child) => {
          const req = child.val();
          totalRequisitions++;
          reqCount[req.materialName] = (reqCount[req.materialName] || 0) + req.quantity;
        });
      }

      document.getElementById('totalRequisitions').textContent = totalRequisitions;

      const sortedReq = Object.entries(reqCount).sort((a, b) => b[1] - a[1]).slice(0, 5);

      const ctx2 = document.getElementById('mostRequisitionedChart');
      if (mostReqChart) mostReqChart.destroy();

      mostReqChart = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: sortedReq.map(r => r[0].length > 15 ? r[0].substring(0, 15) + '...' : r[0]),
          datasets: [{
            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
            data: sortedReq.map(r => r[1]),
            backgroundColor: 'rgba(99, 102, 241, 0.8)',
            borderColor: 'rgba(99, 102, 241, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }).catch((error) => {
      console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥:', error);
      showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÑ‡∏î‡πâ', 'error');
    });
  };

  // Load all data on init
  function loadAllData() {
    console.log('üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
    loadStockData();
    loadRequisitionHistory();
  }

  // Test Firebase connection
  console.log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...');
  if (window.isFirebaseReady) {
    const testRef = window.firebaseRef.ref(window.firebaseDb, '.info/connected');
    window.firebaseRef.onValue(testRef, (snap) => {
      if (snap.val() === true) {
        console.log('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase Realtime Database ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      } else {
        console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase Realtime Database');
      }
    });
  }
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c56b0cf25dc8957',t:'MTc2OTY2ODMyOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>